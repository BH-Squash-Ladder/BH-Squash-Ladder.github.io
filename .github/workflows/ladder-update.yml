name: Update Ladder

on:
  issues:
    types: [labeled]

jobs:
  update-ladder:
    if: contains(github.event.label.name, 'approved')
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install jq
      run: sudo apt-get install -y jq

    - name: Update Ladder Data
      run: |
        FILE="data/ladder.json"
        ISSUE_TITLE="${{ github.event.issue.title }}"
        ISSUE_BODY="${{ github.event.issue.body }}"

        # ADD NEW PLAYER REQUESTS
        if [[ "$ISSUE_TITLE" == Add\ Player:* ]]; then
          NAME="${ISSUE_TITLE#Add Player: }"
          jq --arg name "$NAME" '.players += [{name:$name}]' "$FILE" > tmp && mv tmp "$FILE"
        fi

        # PROCESS CHALLENGE RESULT
        if [[ "${{ github.event.issue.labels.*.name }}" == *"challenge"* ]]; then
          CHALLENGER=$(echo "$ISSUE_BODY" | sed -n 's/Challenger:[[:space:]]*//p' | head -n1 | xargs)
          TARGET=$(echo "$ISSUE_BODY" | sed -n 's/Target:[[:space:]]*//p' | head -n1 | xargs)
          SCORE=$(echo "$ISSUE_BODY" | sed -n 's/Score:[[:space:]]*//p' | head -n1 | xargs)

          C_SCORE=$(echo "$SCORE" | cut -d'-' -f1)
          T_SCORE=$(echo "$SCORE" | cut -d'-' -f2)

          # validate score (best of 5: challenger must win)
          if ! [[ "$C_SCORE" =~ ^[0-5]$ && "$T_SCORE" =~ ^[0-5]$ && "$C_SCORE" -gt "$T_SCORE" ]]; then
            echo "Invalid score, skipping."
            exit 0
          fi

          # get ladder positions
          C_INDEX=$(jq --arg name "$CHALLENGER" '.players | map(.name) | index($name)' $FILE)
          T_INDEX=$(jq --arg name "$TARGET" '.players | map(.name) | index($name)' $FILE)

          # must be within 3 positions below target
          DIFF=$((C_INDEX - T_INDEX))
          if (( DIFF < 1 || DIFF > 3 )); then
            echo "Challenge rank distance invalid, skipping."
            exit 0
          fi

          # Move challenger just above target
          jq \
            --arg challenger "$CHALLENGER" \
            --arg target "$TARGET" \
            '
            .players as $p
            | $p
            | (map(.name) | index($challenger)) as $ci
            | (map(.name) | index($target)) as $ti
            | if $ci < 0 or $ti < 0 then . else
                (del(.[ $ci ]) | .) as $withoutC
                | ($withoutC | .[:$ti] + [{"name": $challenger}] + .[$ti:])
            end
            | {players: .}
            ' "$FILE" > tmp && mv tmp "$FILE"
        fi

    - name: Commit and push
      run: |
        git config user.email "ladder-bot@example.com"
        git config user.name "Ladder Bot"
        git add data/ladder.json
        git commit -m "Ladder updated from approved request" || echo "No changes to commit"
        git push
